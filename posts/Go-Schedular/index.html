<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Go Schedular" /><meta property="og:locale" content="en" /><meta name="description" content="Process Process contains common resources that may be allocated by any process. These resources include but are not limited to a memory address space, handles to files, devices, and threads. Process will have various attributes like Process ID Process State Process Priority Program Counter General purpose register List of open files List of open devices Protection information List of child process Pending alarms Signals and signal handlers Accounting information" /><meta property="og:description" content="Process Process contains common resources that may be allocated by any process. These resources include but are not limited to a memory address space, handles to files, devices, and threads. Process will have various attributes like Process ID Process State Process Priority Program Counter General purpose register List of open files List of open devices Protection information List of child process Pending alarms Signals and signal handlers Accounting information" /><link rel="canonical" href="https://mukeshpilaniya.github.io/posts/Go-Schedular/" /><meta property="og:url" content="https://mukeshpilaniya.github.io/posts/Go-Schedular/" /><meta property="og:site_name" content="pilaniya@home:~$" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-24T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Go Schedular" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-02T01:20:34+05:30","datePublished":"2022-08-24T00:00:00+05:30","description":"Process Process contains common resources that may be allocated by any process. These resources include but are not limited to a memory address space, handles to files, devices, and threads. Process will have various attributes like Process ID Process State Process Priority Program Counter General purpose register List of open files List of open devices Protection information List of child process Pending alarms Signals and signal handlers Accounting information","headline":"Go Schedular","mainEntityOfPage":{"@type":"WebPage","@id":"https://mukeshpilaniya.github.io/posts/Go-Schedular/"},"url":"https://mukeshpilaniya.github.io/posts/Go-Schedular/"}</script><title>Go Schedular | pilaniya@home:~$</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="pilaniya@home:~$"><meta name="application-name" content="pilaniya@home:~$"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/12998935?s=400&u=0874b267fd66e5fea11f5181868ddae3c58e0a93&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">pilaniya@home:~$</a></div><div class="site-subtitle font-italic">Learn.unlearn.relearn</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mukeshpilaniya" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['pilaniyamukesh0','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Go Schedular</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Go Schedular</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1661279400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 24, 2022 </em> </span> <span> Updated <em class="" data-ts="1662061834" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 2, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/mukeshpilaniya">Mukesh Pilaniya</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3059 words"> <em>16 min</em> read</span></div></div></div><div class="post-content"><hr /><h3 id="process"><span class="mr-2">Process</span><a href="#process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><hr /><ul><li>Process contains common resources that may be allocated by any process. These resources include but are not limited to a memory address space, handles to files, devices, and threads.<li>Process will have various attributes like<ul><li>Process ID<li>Process State<li>Process Priority<li>Program Counter<li>General purpose register<li>List of open files<li>List of open devices<li>Protection information<li>List of child process<li>Pending alarms<li>Signals and signal handlers<li>Accounting information</ul></ul><hr /><h3 id="thread"><span class="mr-2">Thread</span><a href="#thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><hr /><ul><li>Thread is a light weight process and an thread will share resources of the process like code, data, global variables, files and memory address space among all the thread within the process but <strong>stack and register</strong> cannot be shared, every thread have it’s own stakcs and registers.<li>Advantages of threads<ul><li>Enhanced throughput of system<li>Imporve responsiveness<li>Faster context switching due to less attributes<li>Effetive utilisation of multiprocessor system<li>Resource sharing (Code, Data, Address Space, Files, Global Variables)</ul><li>User level thread also known as green thread, coroutine in C, <strong>goroutine in Go</strong> and fiber in Ruby.</ul><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Process<th style="text-align: center">Thread (Kernel Thread)<th style="text-align: right">Goroutine / (User Thread)<tbody><tr><td style="text-align: left">Program under execution is known as a process. it should reside in the main memory and occupies cpu to execute instructions and should be in active state.<td style="text-align: center">Kernel level thread is a light weight process and implemented by the Operating system<td style="text-align: right">User level thread also light weighted process but implemented by the user/programmer/programming language<tr><td style="text-align: left">Context switching time between processes is more and creating a process will take more time.<td style="text-align: center">Context switching time between kernel level thread will take less time than context switching between process also creation of kernel level thread also take less time than creation of a process.<td style="text-align: right">User level thread is having less context switching time and creation of user level thread will take less time than kernel level thread.<tr><td style="text-align: left">OS schedular is responsible for scheduling process<td style="text-align: center">The kernel thread scheduler is in charge of scheduling kernel threads.<td style="text-align: right">User/Programming Schedular (Golang schedular) is responsible for shceduling user thread/goroutines.</table></div><p><img data-src="https://github.com/mukeshpilaniya/blog/blob/master/_posts/Golang/images/process_vs_thread.png?raw=true" alt="Process_vs_Thread" data-proofer-ignore></p><blockquote><p>So it’s more efficient to create multiple user thread(goroutine ) inside one process as compare to the process creation which is time consuming and resource intensive.</p></blockquote><hr /><h3 id="go-specific"><span class="mr-2">Go Specific</span><a href="#go-specific" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><hr /><ul><li>In Go user level thread is known as <strong>Goroutine</strong>.<li>Go has took some decision when creating goroutines<ul><li>Easy to create<li>Lightweight<li>Parallel execution<li>Scalable<li>Infinite Stack (Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.)<li>Handling of blocking calls<ul><li>Sending and Receing on Channel<li>Network IO calls<li>Blocking System calls/ syscalls<li>Timers<li>Mutexes</ul><li>Efficient (work stealing)</ul></ul><blockquote><p><strong>Why Go have a schedular ?</strong></p></blockquote><p>Go uses user level thread known as <strong>goroutine</strong> , which are lighter and cheaper than kernel level thread. for example creation of initial goroutine will take 2KB of stack size and kernel level thread will take 8KB of stack size. Also goroutine has faster creation, destruction and faster context switches than kernel thread So go schedular needs to exits to schedule goroutine.OS can’t schedule user level thread, OS only know about kernel level thread. Go schedular multiplexes goroutines to kernel level threads, which will run on the differnet CPU core.</p><blockquote><p><strong>When to schedule goroutines ?</strong></p></blockquote><p>If there is any operation that should or would affect goroutine execution like goroutine starting and blocking call etc…</p><blockquote><p><strong>How go schedular will multiplexes goroutines into kernel threads ?</strong></p></blockquote><ol><li>1:1 Scheduling (Thread per goroutine)<ul><li>Parallel execution (each thread can run on different core)<li>would work but too expensive.<li>memory at least ~32k (memory for user stack and kernel stacks)<li>performance issues (calling syscall)<li>no infinite stack</ul><li>N:1 Scheduling (Multilex all goroutine on a single kernel thread)<ul><li>no parallelism (can only use a single CPU core, even if more cpu core are available)</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">main</span>

 <span class="k">import</span> <span class="p">(</span>
   <span class="s">"fmt"</span>
   <span class="s">"runtime"</span>
   <span class="s">"sync"</span>
 <span class="p">)</span>

 <span class="k">func</span> <span class="n">main</span><span class="p">(){</span>
   <span class="c">// Allocate 1 logical processor for the scheduler to use.</span>
   <span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
   <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
   <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>

   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Starting Goroutines"</span><span class="p">)</span>

   <span class="c">// Declare an anonymous function and create a goroutine.</span>
   <span class="k">go</span> <span class="k">func</span><span class="p">(){</span>
     <span class="c">// Schedule the call to Done to tell main we are done.</span>
     <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
     <span class="c">// Display the alphabet 3 times</span>
       <span class="k">for</span> <span class="n">count</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">count</span><span class="o">&lt;</span><span class="m">3</span><span class="p">;</span><span class="n">count</span><span class="o">++</span><span class="p">{</span>
           <span class="k">for</span> <span class="n">ch</span><span class="o">:=</span><span class="sc">'a'</span><span class="p">;</span><span class="n">ch</span> <span class="o">&lt;</span><span class="sc">'a'</span><span class="o">+</span><span class="m">26</span><span class="p">;</span><span class="n">ch</span><span class="o">++</span><span class="p">{</span>
               <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%c "</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">()</span>
       <span class="p">}</span>
   <span class="p">}()</span>
        
   <span class="c">// Declare an anonymous function and create a goroutine.</span>
   <span class="k">go</span> <span class="k">func</span><span class="p">(){</span>
     <span class="c">// Schedule the call to Done to tell main we are done.</span>
     <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
     <span class="c">// Display the numbers 3 times</span>
       <span class="k">for</span> <span class="n">count</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">count</span><span class="o">&lt;</span><span class="m">3</span><span class="p">;</span><span class="n">count</span><span class="o">++</span><span class="p">{</span>
           <span class="k">for</span> <span class="n">n</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">n</span> <span class="o">&lt;=</span><span class="m">26</span><span class="p">;</span><span class="n">n</span><span class="o">++</span><span class="p">{</span>
               <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">()</span>
       <span class="p">}</span>
   <span class="p">}()</span>
        
   <span class="c">// Wait for the goroutines to finish.</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Waiting To Finish"</span><span class="p">)</span>
   <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Terminating Program"</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="o">&gt;</span> <span class="k">go</span> <span class="n">run</span> <span class="n">main</span><span class="o">.</span><span class="k">go</span>
 <span class="n">Starting</span> <span class="n">Goroutines</span>
 <span class="n">Waiting</span> <span class="n">To</span> <span class="n">Finish</span>
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 

 <span class="n">Terminating</span> <span class="n">Program</span>
</pre></table></code></div></div><ul><li>At line 18 and 31 both functions are created as goroutines by the keyword go. You can see by the output that the code inside each goroutine is running concurrently within a single logical processor. Well you can question by seeing the output of this program they are running one after another, so then how it’s running in concurrent mannar.</ul><blockquote><p><strong>If we set rumtime.GOMAXPROCS() value to 1 than does my program run concurrently ?</strong></p></blockquote><ul><li>Let’s consider the same program with time.Sleep func inside the goroutine, which will force go schedular to shcedular another goroutine when first one is blocked.</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">main</span>

 <span class="k">import</span> <span class="p">(</span>
   <span class="s">"fmt"</span>
   <span class="s">"runtime"</span>
   <span class="s">"sync"</span>
   <span class="s">"time"</span>
 <span class="p">)</span>

 <span class="k">func</span> <span class="n">main</span><span class="p">(){</span>
   <span class="c">// Allocate 1 logical processor for the scheduler to use.</span>
   <span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
   <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
   <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>

   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Starting Goroutines"</span><span class="p">)</span>

   <span class="c">// Declare an anonymous function and create a goroutine.</span>
   <span class="k">go</span> <span class="k">func</span><span class="p">(){</span>
     <span class="c">// Schedule the call to Done to tell main we are done.</span>
     <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
     <span class="c">// Display the alphabet 3 times</span>
       <span class="k">for</span> <span class="n">count</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">count</span><span class="o">&lt;</span><span class="m">3</span><span class="p">;</span><span class="n">count</span><span class="o">++</span><span class="p">{</span>
           <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="m">1</span><span class="p">{</span>
               <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="k">for</span> <span class="n">ch</span><span class="o">:=</span><span class="sc">'a'</span><span class="p">;</span><span class="n">ch</span> <span class="o">&lt;</span><span class="sc">'a'</span><span class="o">+</span><span class="m">26</span><span class="p">;</span><span class="n">ch</span><span class="o">++</span><span class="p">{</span>
               <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%c "</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">()</span>
       <span class="p">}</span>
   <span class="p">}()</span>
        
   <span class="c">// Declare an anonymous function and create a goroutine.</span>
   <span class="k">go</span> <span class="k">func</span><span class="p">(){</span>
     <span class="c">// Schedule the call to Done to tell main we are done.</span>
     <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
     <span class="c">// Display the numbers 3 times</span>
       <span class="k">for</span> <span class="n">count</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">count</span><span class="o">&lt;</span><span class="m">3</span><span class="p">;</span><span class="n">count</span><span class="o">++</span><span class="p">{</span>
           <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="m">0</span><span class="p">{</span>
               <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">5</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="m">2</span><span class="p">{</span>
               <span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">7</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="k">for</span> <span class="n">n</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">n</span> <span class="o">&lt;=</span><span class="m">26</span><span class="p">;</span><span class="n">n</span><span class="o">++</span><span class="p">{</span>
               <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d "</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
           <span class="p">}</span>
           <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">()</span>
       <span class="p">}</span>
   <span class="p">}()</span>
        
   <span class="c">// Wait for the goroutines to finish.</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Waiting To Finish"</span><span class="p">)</span>
   <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Terminating Program"</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="o">&gt;</span> <span class="k">go</span> <span class="n">run</span> <span class="n">main2</span><span class="o">.</span><span class="k">go</span> 
 <span class="n">Starting</span> <span class="n">Goroutines</span>
 <span class="n">Waiting</span> <span class="n">To</span> <span class="n">Finish</span>
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 
 <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="n">e</span> <span class="n">f</span> <span class="n">g</span> <span class="n">h</span> <span class="n">i</span> <span class="n">j</span> <span class="n">k</span> <span class="n">l</span> <span class="n">m</span> <span class="n">n</span> <span class="n">o</span> <span class="n">p</span> <span class="n">q</span> <span class="n">r</span> <span class="n">s</span> <span class="n">t</span> <span class="n">u</span> <span class="n">v</span> <span class="n">w</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> 
 <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">13</span> <span class="m">14</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">20</span> <span class="m">21</span> <span class="m">22</span> <span class="m">23</span> <span class="m">24</span> <span class="m">25</span> <span class="m">26</span> 

 <span class="n">Terminating</span> <span class="n">Program</span>
</pre></table></code></div></div><ul><li>Here you can see even if we set runtime.GOMAXPROCS(1) to 1, the program is running concurrently.<li>Number of Goroutine in Running sate can be max at 1, Block Goroutine can be more than one and all other Goroutine are in Runnable state.</ul><li>Thread Pool<ul><li>Create thread when needed which means create a thread if there are goroutine to run but all the other threads are busy.<li>Once the thread complete it’s execution rather than distroying reuse it.<li>this can only faster goroutine creation because we can reuse threads<li>but still more memory consumption, performance issue and no infinite stacks.</ul><li>M:N Threading Shared Run Queue Schedular<ul><li>M represents number of OS Thread<li>N represents number of goroutine<li>Creation of goroutine is cheap and we can fully control complete lifecycle of goroutine beacuse it’s created in user space.<li>Creation of OS thread is expensive and we don’t have control over it but using multiple thread we can achieve parallelism.<li>In this model multiple goroutine is multiplex into kernel threads.<li>Goroutine state<ul><li>Running<li>Runnable<li>Blocked<ul><li>Blocked on the Channel<li>Mutexes<li>Network IO<li>Timers<li>System Call</ul></ul><li>Blocked Goroutine example</ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">main</span>

 <span class="k">import</span> <span class="p">(</span>
     <span class="s">"time"</span>
     <span class="s">"fmt"</span>
     <span class="s">"sync"</span>
     <span class="s">"os"</span>
     <span class="s">"net/http"</span>
     <span class="s">"io/ioutil"</span>
 <span class="p">)</span>

 <span class="c">// Global worker variable</span>
 <span class="k">var</span> <span class="n">worker</span> <span class="kt">int</span>

 <span class="k">func</span> <span class="n">writeToFile</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,){</span>
     <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
        
     <span class="n">file</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">OpenFile</span><span class="p">(</span><span class="s">"file.txt"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_CREATE</span><span class="p">,</span> <span class="m">0755</span><span class="p">)</span>             <span class="c">// Blocking System Call</span>
     <span class="n">resp</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"https://mukeshpilaniya.github.io/posts/Go-Schedular/"</span><span class="p">)</span> <span class="c">// Blocking Network IO Call</span>
     <span class="n">body</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">ioutil</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>                                        <span class="c">// Blocking System Call</span>

     <span class="n">file</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
 <span class="p">}</span>

 <span class="k">func</span> <span class="n">workerCount</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span><span class="p">,</span> <span class="n">ch</span> <span class="k">chan</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span> 
     <span class="c">// Lock() the mutex to ensure </span>
     <span class="c">// exclusive access to the state, </span>
     <span class="c">// increment the value,</span>
     <span class="c">// Unlock() the mutex</span>
     <span class="n">m</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>                                                                    <span class="c">// Blocked On Mutex</span>
     <span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span> <span class="o">+</span> <span class="m">1</span>
     <span class="n">ch</span> <span class="o">&lt;-</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Worker %d is ready"</span><span class="p">,</span><span class="n">worker</span><span class="p">)</span>
     <span class="n">m</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
      
     <span class="c">// On return, notify the </span>
     <span class="c">// WaitGroup that we’re done.</span>
     <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
 <span class="p">}</span>

 <span class="k">func</span> <span class="n">printWorker</span><span class="p">(</span><span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">done</span> <span class="k">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">ch</span> <span class="k">chan</span> <span class="kt">string</span><span class="p">){</span>
        
     <span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="m">100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
         <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="n">ch</span><span class="p">)</span>                                               <span class="c">// Blocked On Channel</span>
     <span class="p">}</span>
     <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
     <span class="n">done</span> <span class="o">&lt;-</span><span class="no">true</span>
 <span class="p">}</span>

 <span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        
     <span class="c">// Creating Channel</span>
     <span class="n">ch</span> <span class="o">:=</span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">string</span><span class="p">)</span>
     <span class="n">done</span> <span class="o">:=</span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">bool</span><span class="p">)</span>
        
     <span class="c">// This mutex will synchronize access to state</span>
     <span class="k">var</span> <span class="n">mu</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
        
     <span class="c">// This WaitGroup is used to wait for </span>
     <span class="c">// all the goroutines launched here to finish.</span>
     <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
        
     <span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="m">100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">{</span>
         <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
         <span class="k">go</span> <span class="n">workerCount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wg</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mu</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span>
     <span class="p">}</span>
        
     <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
     <span class="k">go</span> <span class="n">writeToFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wg</span><span class="p">)</span>
     <span class="k">go</span> <span class="n">printWorker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wg</span><span class="p">,</span><span class="n">done</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span>
        
     <span class="c">// Waiting for program to Finish</span>
     <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
        
     <span class="o">&lt;-</span><span class="n">done</span>                                                             <span class="c">// Blocked On Channel</span>
        
     <span class="o">&lt;-</span><span class="n">time</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="m">1</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>                                        <span class="c">//Blocked On Timer</span>
     <span class="nb">close</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
     <span class="nb">close</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
 <span class="p">}</span>
</pre></table></code></div></div><ul><li><p>In line number 18 and 20 Goroutine is blocked on System call, in line 19 blocked on network IO call, in line 30 blocked on mutex, in line 43 and 74 blocked on channel and in line 76 it’s blocked on timer. Now we will look how goschedular will work in these cases.</p><li><p>If a goroutine is blocked on the channel then the channel is having wait Queue(line 10) and all blocked goroutine is listed on the wait queue and it’s easly trackable. After the blocking call they will be placed into global run queue of schedular and OS Thread will again pick goroutine in FIFO order.</p></ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre> <span class="k">type</span> <span class="n">hchan</span> <span class="k">struct</span> <span class="p">{</span>
   <span class="n">qcount</span>   <span class="kt">uint</span>           <span class="c">// total data in the queue</span>
   <span class="n">dataqsiz</span> <span class="kt">uint</span>           <span class="c">// size of the circular queue</span>
   <span class="n">buf</span>      <span class="n">unsafe</span><span class="o">.</span><span class="n">Pointer</span> <span class="c">// points to an array of dataqsiz elements</span>
   <span class="n">elemsize</span> <span class="kt">uint16</span>
   <span class="n">closed</span>   <span class="kt">uint32</span>
   <span class="n">elemtype</span> <span class="o">*</span><span class="n">_type</span> <span class="c">// element type</span>
   <span class="n">sendx</span>    <span class="kt">uint</span>   <span class="c">// send index</span>
   <span class="n">recvx</span>    <span class="kt">uint</span>   <span class="c">// receive index</span>
   <span class="n">recvq</span>    <span class="n">waitq</span>  <span class="c">// list of recv waiters</span>
   <span class="n">sendq</span>    <span class="n">waitq</span>  <span class="c">// list of send waiters</span>
    
   <span class="c">// lock protects all fields in hchan, as well as several</span>
   <span class="c">// fields in sudogs blocked on this channel.</span>
   <span class="c">//</span>
   <span class="c">// Do not change another G's status while holding this lock</span>
   <span class="c">// (in particular, do not ready a G), as this can deadlock</span>
   <span class="c">// with stack shrinking.</span>
   <span class="n">lock</span> <span class="n">mutex</span>
 <span class="p">}</span>
</pre></table></code></div></div><p><img data-src="/assets/images/shared_schedular_during_channel_operations.gif" alt="Goroutiine Block On Channel" data-proofer-ignore></p><ul><li>The same mechanism is used for Mutexes, Timers and Network IO.<li>If a goroutine is blocked on the system call then the situation is differnt because we don’t know what is happing in the kernel space. Channels are created in the user space so we have full control over it but in the case of system call we don’t have.<li>Blocking system call will block goroutine and underline kernel thread as well.<li>Let’s suppose that one goroutine is made a syscall which is scheduled on one kernel thread, when a kernel thread is complete is execution it will wake up another kernel thread(thread reuse) that will pick up another goroutine and start executing it.This is a ideal scenario but in real case we don’t know how much time syscall will take so we can’t relay on the kernel thread to wake up another thread, we need some <strong>code level logic</strong> which will decide when to wake up another thread in case of syscall. This logic is implemented in golang as runtime·entersyscall()(line 2) and runtime·exitsyscall() (line 18). which means number of kernel thread can be more than number of core.<li>System call code snippet of golang 1.19 https://cs.opensource.google/go/go/+/refs/tags/go1.19:src/syscall/asm_linux_arm.s;l=18</ul><div class="language-sh highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre> TEXT ·seek<span class="o">(</span>SB<span class="o">)</span>,NOSPLIT,<span class="nv">$0</span><span class="nt">-28</span>
   BL	runtime·entersyscall<span class="o">(</span>SB<span class="o">)</span>
   MOVW	<span class="nv">$SYS__LLSEEK</span>, R7	// syscall entry
   MOVW	fd+0<span class="o">(</span>FP<span class="o">)</span>, R0
   MOVW	offset_hi+8<span class="o">(</span>FP<span class="o">)</span>, R1
   MOVW	offset_lo+4<span class="o">(</span>FP<span class="o">)</span>, R2
   MOVW	<span class="nv">$newoffset_lo</span>+16<span class="o">(</span>FP<span class="o">)</span>, R3
   MOVW	whence+12<span class="o">(</span>FP<span class="o">)</span>, R4
   SWI	<span class="nv">$0</span>
   MOVW	<span class="nv">$0xfffff001</span>, R6
   CMP	R6, R0
   BLS	okseek
   MOVW	<span class="nv">$0</span>, R1
   MOVW	R1, newoffset_lo+16<span class="o">(</span>FP<span class="o">)</span>
   MOVW	R1, newoffset_hi+20<span class="o">(</span>FP<span class="o">)</span>
   RSB	<span class="nv">$0</span>, R0, R0
   MOVW	R0, err+24<span class="o">(</span>FP<span class="o">)</span>
   BL	runtime·exitsyscall<span class="o">(</span>SB<span class="o">)</span>
   RET
</pre></table></code></div></div><ul><li>When the system call is made to the kernel then it has two decideding points, one is entry point and another one is exit point.</ul><p><img data-src="/assets/images/shared_schedular_during_system_call_operations.gif" alt="Goroutine Blocked on SysCall" data-proofer-ignore></p><blockquote><p><strong>How many kernel thread OS can supports ?</strong></p></blockquote><p>In Linux Kernel this parameter is defined in the file /proc/sys/kernel/threads-max which is specific to perticular kernel.</p><p><code class="language-plaintext highlighter-rouge">sh:~$ cat /proc/sys/kernel/threads-max 94751</code><br /> Here, the output 94751 indicates that the kernel can execute a maximum of 94751 threads.</p><blockquote><p><strong>How many goroutine per program Go can support ?</strong></p></blockquote><p>There is no restriction built into the schedular for the number of goroutines.</p><blockquote><p><strong>How many kernel thread per program GO can support ?</strong></p></blockquote><p>The runtime limits each program to a maximum of 10,000 threads by default. This value can be changed by calling the SetMaxThreads function from the runtime/debug package. https://github.com/golang/go/blob/67d85ad00f9d9be0cc2bb1bb96d01c3d40dcb376/src/runtime/proc.go#L686</p><ul><li>Conclusion<ul class="task-list"><li>Number of kernel thread can be more than number of core. #kernel Thread &gt;#Core<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />lightweight goroutines<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />handling of IO and syscalls<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />parallel executions of goroutine<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />scalable (All the kernel level thread try to acess gloabl run queue with mutex enable. So due to <strong>contention</strong> this is not easy to scale)</ul></ul><li>M:N Threading Distributed Run Queue Scheduler<br /> To solve the sclable problem where every thread is try to access the mutex at the same time, per thread local run queue is maintained.<ul><li>Per thread state (local run queue)<li>Still have global run queue</ul><p><img data-src="/assets/images/distributed_schedular.gif" alt="Distributed Run Queue" data-proofer-ignore></p><ul><li>Local queue of runnable goroutines, accessed without lock.<li><p>Global queue of runnable goroutines, require lock.</p><li>Conclusion<ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />lightweight goroutines<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />handling of IO and SystemCalls<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Parallel execution of goroutines<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Scalable<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Efficient (#threads &gt; #cores)</ul></ul><blockquote><p>If number of thread is more than number of cores than what is the problem ?</p></blockquote><p>In distributed run queue schedular we know that each thread is having their own local run queue which contains information about which goroutine going to be execute next.Also due to syscall, number of thread will increase and most of time their local run queue is empty. So if the number of threads are greater than number of cores than during the <strong>work stealing</strong> process each thread has to scan all the thread local run queue and most of time they are empty so if threads are more than this process is time consuming and the solution is not efficent so we need to limit thread scanning to a constant which is solve using M:P:N threading model.</p><li>M:P:N Threading<ul><li>P represented Processor that are resource required to run the go code. <details open=""> <summary>Processor Struct Details</summary> <br /> https://github.com/golang/go/blob/63e129ba1c458db23f0752d106ed088a2cf38360/src/runtime/runtime2.go#L601 </details><li>M represented worker thread, or machine. <details open=""> <summary>Machine Thread Struct Details</summary> <br /> https://github.com/golang/go/blob/63e129ba1c458db23f0752d106ed088a2cf38360/src/runtime/runtime2.go#L519 </details><li>G represented goroutine. <details open=""> <summary>Goroutine Struct Details</summary> <br /> https://github.com/golang/go/blob/63e129ba1c458db23f0752d106ed088a2cf38360/src/runtime/runtime2.go#L407 </details><li>Generally number of processor is same as number of <strong>logical Processor</strong>.<li><strong>Logical Processor</strong> is not same as <strong>physical processor</strong>.<li>Processors are created before starting of the main go routine.<blockquote><p><strong>How to check number of logical processors ?</strong></p></blockquote></ul><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">main</span>

 <span class="k">import</span> <span class="p">(</span>  
     <span class="s">"fmt"</span>
     <span class="s">"runtime"</span>
 <span class="p">)</span>

 <span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
     <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">NumCPU</span><span class="p">())</span>
 <span class="p">}</span>
</pre></table></code></div></div><ul><li>Distributed M:P:N Schedular</ul><p><img data-src="/assets/images/distributed_processor_schedular.gif" alt="Distributed Schedular" data-proofer-ignore></p><ul><li>During the syscall operation handoff of logical processor is performed. https://github.com/golang/go/blob/master/src/runtime/proc.go#L1486</ul><p><img data-src="/assets/images/distributed_schedular_during_system_call.gif" alt="System call operation" data-proofer-ignore></p><ul><li>During the work stealing only fixed number number of queue has to be scan because number of logical processors are limited.</ul><blockquote><p><strong>What is the next goroutine to run ?</strong></p></blockquote><p>Go schedular will check in following order to pick next goroutine to execute</p><ul><li> <details open=""> <summary>Local Run Queue</summary> <br /> https://github.com/golang/go/blob/67d85ad00f9d9be0cc2bb1bb96d01c3d40dcb376/src/runtime/proc.go#L5981 </details><p><img data-src="/assets/images/distributed_processor_schedular.gif" alt="Local run queue" data-proofer-ignore></p><li> <details open=""> <summary>Global Run Queue</summary> <br /> https://github.com/golang/go/blob/67d85ad00f9d9be0cc2bb1bb96d01c3d40dcb376/src/runtime/proc.go#L5662 </details><p><img data-src="/assets/images/distributed_schedular_during_empty_local_run_queue.gif" alt="local run queue" data-proofer-ignore></p><li> <details open=""> <summary>Network poller</summary> <br /> https://github.com/golang/go/blob/67d85ad00f9d9be0cc2bb1bb96d01c3d40dcb376/src/runtime/netpoll_aix.go#L154 </details><p><img data-src="/assets/images/distributed_schedular_during_empty_global_run_queue.gif" alt="Global run queue" data-proofer-ignore></p><li> <details open=""> <summary>Work Stealing</summary> <br /> https://github.com/golang/go/blob/67d85ad00f9d9be0cc2bb1bb96d01c3d40dcb376/src/runtime/proc.go#L2942 </details><p><img data-src="/assets/images/distributed_schedular_during_empty_net_poller_ready_run_queue.gif" alt="net poller" data-proofer-ignore></p><li>Conclusion<ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />lightweight goroutines<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />handling of IO and System calls<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Parallel execution of goroutines<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Scalable<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Efficient/Work stealing</ul></ul><li>Limitations of Go schedular<ul><li>FIFO is Bad for locality principle<li>No notion of goroutine priorities (unlike linux kernel)<li>No strong preemption -&gt; no strong fairness or latency guarantees.<li>It’s not aware of the system topology -&gt; no real locality. There is an old NUMA-aware scheduler proposal. Also a suggestion to use LIFO queue so its more likely to have data in that CPU cores cache.</ul></ol><h3 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>https://medium.com/@ankur_anand/illustrated-tales-of-go-runtime-scheduler-74809ef6d19b<li>https://www.morsmachine.dk/go-scheduler<li>https://go.dev/src/runtime/proc.go<li>Scalable Go Scheduler Design Doc<li>Analysis of the Go runtime scheduler<li>Go scheduler: Implementing language with lightweight concurrency</ul></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Go+Schedular+-+pilaniya%40home%3A~%24&url=https%3A%2F%2Fmukeshpilaniya.github.io%2Fposts%2FGo-Schedular%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Go+Schedular+-+pilaniya%40home%3A~%24&u=https%3A%2F%2Fmukeshpilaniya.github.io%2Fposts%2FGo-Schedular%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmukeshpilaniya.github.io%2Fposts%2FGo-Schedular%2F&text=Go+Schedular+-+pilaniya%40home%3A~%24" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Go-Schedular/">Go Schedular</a><li><a href="/posts/Solving-modern-programming-challenges-with-Go/">Solving Modern Programming Challenges With Go</a><li><a href="/posts/Classroom-Management-System/">Classroom Management System</a><li><a href="/posts/Calculator-With-DevOps-Tool-Chain/">Calculator With Devops Tool Chain</a><li><a href="/posts/CP-competitive-programming-time-complexity/">Cp Competitive programming time Complexity</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/hibernate/">hibernate</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cp/">cp</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/golang/">golang</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Solving-modern-programming-challenges-with-Go/"><div class="card-body"> <em class="small" data-ts="1660674600" data-df="ll" > Aug 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Solving Modern Programming Challenges With Go</h3><div class="text-muted small"><p> Development speed Consequently, many Go applications compile in under a second. The entire Go source tree compiles in under 20 seconds on modern hardware. Writing applicat...</p></div></div></a></div><div class="card"> <a href="/posts/Array-Slice-And-Map-in-Golang/"><div class="card-body"> <em class="small" data-ts="1660069800" data-df="ll" > Aug 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Array Slice And Map In Golang</h3><div class="text-muted small"><p> Array Array Internals and fundamentals An array in Go is a fixed-length data type that contains a contiguous block of elements of the same type. Arr...</p></div></div></a></div><div class="card"> <a href="/posts/Auth/"><div class="card-body"> <em class="small" data-ts="1643999400" data-df="ll" > Feb 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Authentication Service</h3><div class="text-muted small"><p> DockerHub Profile: https://hub.docker.com/repository/docker/pilaniya1337/authservice GitHub Profile:https://github.com/mukeshpilaniya/auth MakeFile Start the application make up ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Solving-modern-programming-challenges-with-Go/" class="btn btn-outline-primary" prompt="Older"><p>Solving Modern Programming Challenges With Go</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://www.linkedin.com/in/mukeshpilaniya">Mukesh Pilaniya</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/hibernate/">hibernate</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/jenkins/">jenkins</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cp/">cp</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/elk/">elk</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/golang/">golang</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HJFWMSHT9C"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HJFWMSHT9C'); }); </script>
